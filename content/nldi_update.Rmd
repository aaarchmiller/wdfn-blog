---
title: "Network Linked Data Index Update and Client Applications"
author: "David Blodgett"
slug: "nldi_update"
date: "2020-01-07"
keyword1: "NHDPlus"
output: USGSmarkdowntemplates::hugo
description:  "An update on the Network Linked Data Index Web Application Programming Interface and Client Applications"
author_email: dblodgett@usgs.gov
author_github: dblodgett-usgs
author_twitter: D_Blodgett
author_staff: david-l-blodgett
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(knitr)
knit_hooks$set(plot=function(x, options) {
  sprintf("{{<figure src='/%s%s-%d.%s' title='%s' alt='%s' >}}",
          options$fig.path, options$label,
          options$fig.cur, options$fig.ext,
          options$fig.cap, options$alt.text)
})
opts_chunk$set(
  echo=TRUE,
  fig.path="static/nldi_update/",
  fig.cap = "TODO",
  alt.text = "TODO",
  fig.width = 7,
  fig.height = 5,
  class = "",
  message = FALSE,
  warnings = FALSE
)
```

In August 2020, the Hydro Network Linked Data Index (NLDI) was updated with some new functionality and some changes to the existing Web Application Programming Interface (API). This post summarizes these changes and demonstrates Python and R clients available to work with the functionality. 

If you are new to the NLDI, visit the [nldi-intro](https://waterdata.usgs.gov/blog/nldi-intro/) blog to get up to speed. This post assumes a basic understanding of the API.

## Summary

The new functionality added to the NLDI is the ability to retrieve local or accumulated catchment characteristics for any `featureSource` available from the system. A selection of characteristics from [this data release](https://www.sciencebase.gov/catalog/item/5669a79ee4b08895842a1d470) are included. This is detailed further down in this post.

API changes are backward compatible but fairly significant.
- If using a web-browser, `?f=json` needs to be appended to requests to see JSON content.
- The `navigate` endpoint is deprecated in favor of a `navigation` end point with slightly different behavior.
-- previously, a `navigate/{navigationMode}` request would return flowlines. The `navigation/{navigationMode}` endpoint now returns available `dataSources`, treating flowlines as a data source.
-- All `navigationMode`s now require the `distance` query parameter. Unconstrained navigation queries (the default from the `navigate` endpoint) were causing system performance problems. Client applications must now explicitly request very large upstream with tributaries queries to avoid performance issues due to naive client requests.
- All features in a `featureSource` can now be accessed at the `featureSource` endpoint. This will allow clients to easily create map-based selection interfaces.
- A `featureSource` can now be queried with a lat/lon point encoded in `WKT` format.

## API Updates Detail

The API updates were tracked in a [github release here.](https://github.com/ACWI-SSWD/nldi-services/issues?q=is%3Aissue+milestone%3AV+is%3Aclosed) These updates aimed to make the API more consistent and improve overall scalability of the system. The following sections describe the changes in some detail.

### Media type handling changes.

Previous to the recent release, the NLDI only supported JSON responses. This caused problems in a browser when an unsuspecting person accessed an API request that returned a large JSON document in a Web browser. To protect against this, any request from with Accept headers preferring text/html content (e.g. from a Web browser) is provided an HTML response containing a link to the JSON content. An Accept header override -- `?f=json` -- is used for this behavior. If requests are made without an Accept header, JSON content is returned.

This behavior can be seen at any endpoint exposed by the NLDI. e.g. open the following url in a browser. https://labs.waterdata.usgs.gov/api/nldi/linked-data/nwissite/USGS-05429700

### Navigation end point.

The original NLDI `.../navigate` end point had a design inconsistency and behavior that led to needless high-cost queries. `.../navigate` has been deprecated and a `.../navigation` endpoint has been introduced in its place. 

The most significant change is the resource returned from a particular navigation mode endpoint. e.g. https://labs.waterdata.usgs.gov/api/nldi/linked-data/nwissite/USGS-05429700/navigation/UM is now a JSON document listing available data sources that can be accessed for the upstream main navigation from the featureID USGS-05429700 from the nwissite featureSource. In contrast, the `.../navigate/UM` returns GeoJSON containing flowlines for the upstream main navigation. The same flowlines GeoJSON is now a dataSource listed along side the others available for the `.../navigation/UM` end point.

The other significant difference between the `.../navigate` and `.../navigation` endpoints is that the `distance` (in km) query parameter is now required. Previously, the internal default was set to 9999 which resulted in many very large requests that may or may not have been desired. There is no upper limit to the value of the `distance` parameter, but it must be provided for the navigation end point to trigger a query to the NLDI's database. Client developers are encouraged to choose a sensible default such that naive users will not accidentally trigger very large queries and be aware that the NLDI is capable of producing result sets with hundreds of thousands of features. 

### Feature Source Access

Prior to this release, end points such as: https://labs.waterdata.usgs.gov/api/nldi/linked-data/huc12pp did not return a resource. This made it difficult to discover available feature sources. This `featureSource` end point now returns a GeoJSON document containing all features from the requested feature source. These are quite large and no further query functions are implemented. In future releases, an OGC API Features interface may be made available to allow queries against the feature sources.

## Catchment Characteristics

The correspondence between feature sources and NHDPlusV2 catchments is important to understand for catchment characteristics.

At its core, the NLDI contains the NHDPlusV2 catchment network. As such, all navigation requests resolve to the nearest catchment and an equivalent query can be made directly to the COMID that a feature source is indexed to. e.g.

`https://labs.waterdata.usgs.gov/api/nldi/linked-data/nwissite/USGS-05429700/navigation/`

is equivalent to:

`https://labs.waterdata.usgs.gov/api/nldi/linked-data/comid/13297194/navigation/`

because `nwissite/USGS-05429700` is indexed to `comid/13297194`.

Given this, we can access catchment characteristics for a catchment or an indexed feature with the `local`, `tot`, or `div` end points. e.g.

`https://labs.waterdata.usgs.gov/api/nldi/linked-data/comid/13297194/local`

or

`https://labs.waterdata.usgs.gov/api/nldi/linked-data/nwissite/USGS-05429700/local`

provide exactly the same content.

- The `local` end point provides characteristics for the local catchment. 
- The `tot` end point provides total-upstream characteristics.
- The `div` end point provides divergence-routed upstream characteristics.

Documentation for the source dataset and creation methods [can be found here.](https://www.sciencebase.gov/catalog/item/5669a79ee4b08895842a1d47)

An endpoint to lookup metadata for specific characteristics is available here:

`https://labs.waterdata.usgs.gov/api/nldi/lookups`

Only selected catchment characteristics from the source data release are included at this time. More may be added in the future. Please reach out in a github issue [here](https://github.com/ACWI-SSWD/nldi-services/issues) to request additiona characteristics be added.

## Python Client Application

lorum ipsum

## R client Application

```{r, echo=FALSE}
options("rgdal_show_exportToProj4_warnings"="none")
```

```{r}
library(dplyr)
library(sf)
library(nhdplusTools)

nldi_feature <- list(featureSource = "nwissite", 
                     featureID = "USGS-01031500")

outlet_comid <- discover_nhdplus_id(nldi_feature = nldi_feature)

data <- plot_nhdplus(nldi_feature, flowline_only = FALSE)

chars <- discover_nldi_characteristics()

outlet_total <- get_nldi_characteristics(nldi_feature, type = "total")

outlet_total <- left_join(outlet_total$total, chars$total, 
                          by = "characteristic_id")

outlet_total <- outlet_total %>%
  select(ID = characteristic_id, 
                       Dataset = dataset_label,
                       Description = characteristic_description, 
                       Value = characteristic_value,
                       Units = units,
                       link = dataset_url) %>%
  mutate(link = paste0('<a href="', link, '">link</a>'))

knitr::kable(outlet_total)
```

```{r}
characteristic <- "CAT_RECHG"
tot_char <- "TOT_RECHG"

all_local <- sapply(data$flowline$COMID, function(x, char) {
  chars <- get_nldi_characteristics(
    list(featureSource = "comid", featureID = as.character(x)), 
    type = "local")
  
  filter(chars$local, characteristic_id == char)$characteristic_value
  
}, char = characteristic)

local_characteristic <- data.frame(COMID = data$flowline$COMID)
local_characteristic[[characteristic]] = as.numeric(all_local)

cat <- right_join(data$catchment, local_characteristic, by = c("FEATUREID" = "COMID"))

plot(cat[characteristic])
```

```{r}
net <- prepare_nhdplus(data$flowline, 0, 0, 0, purge_non_dendritic = FALSE)

net <- select(net, ID = COMID, toID = toCOMID) %>%
  left_join(select(st_drop_geometry(data$flowline), COMID, AreaSqKM), 
            by = c("ID" = "COMID")) %>%
  left_join(local_characteristic, by = c("ID" = "COMID"))


net[["temp_col"]] <- net[[characteristic]] * net$AreaSqKM

net[[tot_char]] <- nhdplusTools:::accumulate_downstream(net, "temp_col")
net$DenTotDASqKM <- nhdplusTools:::accumulate_downstream(net, "AreaSqKM")

net[[tot_char]] <- net[[tot_char]] / net$DenTotDASqKM

cat <- right_join(data$catchment, 
                  select(net, -temp_col, -toID, -DenTotDASqKM), 
                  by = c("FEATUREID" = "ID"))

plot(cat[tot_char], reset = FALSE)
plot(st_geometry(data$flowline), add = TRUE, lwd = data$flowline$StreamOrde, col = "lightblue")
filter(outlet_total, ID == tot_char)$Value

filter(cat, FEATUREID == outlet_comid)[[tot_char]]
```
